
##################
### MAIN FILES ###
##################

[include mainsail.cfg]
#[include config/printer.cfg]
#[include board_pins.cfg]
#[include software/variables.cfg]
[include Klicky/*.cfg]
[include macros.cfg]
[include software/sensorless.cfg]
#[include manta-m5p.cfg]
[include ebbcan_G0B1_v1.2.cfg]
[include software/Adaptive_Purge.cfg]
[include software/Adaptive_Mesh.cfg]
[exclude_object]

###########################
### HARDWARE COMPONENTS ###
###########################
[include hardware/fans.cfg]
[include hardware/XY.cfg]
[include hardware/Z.cfg]
#[include hardware/heated_bed.cfg]
#[include hardware/probe.cfg]
[include hardware/temperature_sensors.cfg]
[include hardware/stealthburner_leds.cfg]
[include hardware/led_effects.cfg]

[virtual_sdcard]
path: /home/biqu/printer_data/gcodes

[display_status]

[mcu]

canbus_uuid: 6cb991e48d03 


#[mcu pico]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_455035712914F2C8-if00
#restart_method: command

[mcu cbi]
serial: /tmp/klipper_host_mcu

[printer]
kinematics: corexy
max_velocity: 250 #default 300
max_accel: 8000 #Input Shaper advised x16300 / y19000, set at 10000 to be conservative
max_z_velocity: 15
max_z_accel: 45
square_corner_velocity: 5.0

[extruder]
step_pin: can0:EXT_STEP
dir_pin: can0:EXT_DIR
enable_pin: !can0:EXT_EN
rotation_distance: 53.494165 #5.57 #26.72306036
gear_ratio: 44:10, 37:17 #50:10 
microsteps: 32 #16
full_steps_per_rotation: 200 
max_extrude_only_distance: 1400.0
max_extrude_only_velocity: 75.0 
max_extrude_only_accel: 1500 
max_extrude_cross_section: 0.8
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: can0:HE0
sensor_pin: can0:TH0
sensor_type: ATC Semitec 104GT-2 
pullup_resistor: 2200             
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
min_extrude_temp: 170
min_temp: 0
max_temp: 270
pressure_advance: 0.035                                              
pressure_advance_smooth_time: 0.040

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: can0:EXT_UART
stealthchop_threshold: 0
run_current: 0.30

[heater_bed]
heater_pin: PA5
sensor_type: Generic 3950
sensor_pin: PA0
smooth_time: 3.0
pwm_cycle_time: 0.01612
min_temp: 0
max_temp: 120
#control: pid                                                        
#pid_kp: 68.453
#pid_ki: 2.749
#pid_kd: 426.122

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[probe]

pin: ^can0:LIMIT_1 
# Determined from CAD.
# ZeroClick probe position is 7mm from edge.  
# Magnet center is 5mm from edge.
# 9mm between magnet centers.  
# 4.5mm offset + 5mm - 7 --> 2.5mm offset from center of ZeroClick
# 20.95mm X offset from center of toolhead to center of ZeroClick; 21 - 2.5 is -18.5 X offset
# From CAD: 18.2mm Y offset.
x_offset: -18.5
y_offset: 17.5
#z_offset: 10.884
speed: 10 #5
lift_speed: 7
samples: 3
samples_result: median
sample_retract_dist: 2
samples_tolerance: 0.01
samples_tolerance_retries: 10


[servo klicky_servo]
#check were your servo is wired
pin: PC15
maximum_servo_angle: 180
minimum_pulse_width: 0.00025
maximum_pulse_width: 0.0024

[gcode_macro _servo_test_angle]
gcode:
    	{% set ANGLE  = params.ANGLE|int %}

    SET_SERVO SERVO=klicky_servo ANGLE={ANGLE}
    G4 P250
    SET_SERVO SERVO=klicky_servo WIDTH=0.0


[z_tilt]
  z_positions:          #Bed frame attachment points
    -48, 14
    60, 140
    168, 14
  points:               #points to probe the bed (ZeroClick)
    25, 6
    77, 88
    117, 6
  speed: 75
  horizontal_move_z: 20
  retries: 6
  retry_tolerance: 0.0075   #.0075


[idle_timeout]
timeout: 1800
gcode:
    TURN_OFF_HEATERS
    SET_FAN_SPEED FAN=Nevermore SPEED=0    
    M84
    STATUS_OFF

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.765
#*# pid_ki = 1.275
#*# pid_kd = 101.590
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 61.732
#*# pid_ki = 1.524
#*# pid_kd = 625.037
#*#
#*# [probe]
#*# z_offset = 10.250
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.030000, -0.025000, -0.020000, -0.015000, -0.015000
#*# 	  -0.045000, -0.025000, -0.005000, 0.005000, 0.005000
#*# 	  -0.045000, -0.040000, -0.020000, 0.005000, 0.020000
#*# 	  -0.055000, -0.030000, -0.015000, 0.015000, 0.040000
#*# 	  -0.080000, -0.050000, -0.015000, 0.025000, 0.055000
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 25.009999999999998
#*# max_x = 91.97
#*# min_y = 25.009999999999998
#*# max_y = 90.97
